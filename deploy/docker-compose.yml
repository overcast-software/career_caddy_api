version: '3.8'

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: ${DB_NAME:-job_hunting}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
      - "${TAILSCALE_IP}:5432:5432"



  web:
    image: ${IMAGE_REPO}:${IMAGE_TAG}
    command: sh -c "python manage.py ensuredb && python manage.py migrate && python manage.py initsa && gunicorn -c gunicorn.conf.py job_hunting.wsgi:application"
    ports:
      - "127.0.0.1:8025:8000"
    depends_on:
      - db
    environment:
      DEBUG: 'False'
      SECRET_KEY: ${SECRET_KEY:-change-in-production}
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@db:5432/${DB_NAME:-job_hunting}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-api.careercaddy.online,careercaddy.online,www.careercaddy.online,localhost,127.0.0.1}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-https://careercaddy.online,https://www.careercaddy.online}
      CORS_ALLOWED_ORIGIN: ${CORS_ALLOWED_ORIGIN:-}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-https://careercaddy.online,https://www.careercaddy.online,https://api.careercaddy.online}
      SCRAPING_ENABLED: ${SCRAPING_ENABLED:-True}
      ALLOW_BOOTSTRAP_SUPERUSER: ${ALLOW_BOOTSTRAP_SUPERUSER:-False}
      BOOTSTRAP_TOKEN: ${BOOTSTRAP_TOKEN:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GUNICORN_HOST: 0.0.0.0
      GUNICORN_PORT: "8000"

volumes:
  postgres_data:
